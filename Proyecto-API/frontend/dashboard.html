<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Motor HMI</title>
    <link rel="stylesheet" href="/static/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .metric-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }
        
        .metric-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }
        
        .metric-label {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .status-running { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-error { background-color: #dc3545; }
        .status-offline { background-color: #6c757d; }
        
        #chartContainer {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        #chartCanvas {
            max-height: 400px;
        }

        .events-container {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .event-item {
            padding: 12px;
            margin: 8px 0;
            border-left: 4px solid #ffc107;
            background: #fff3cd;
            border-radius: 5px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .event-critical {
            border-left-color: #dc3545;
            background: #f8d7da;
        }

        .device-info {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .btn-refresh {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .btn-refresh:hover {
            transform: scale(1.05);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <div>
                <h1><i class="fas fa-tachometer-alt"></i> Dashboard Motor HMI</h1>
            </div>
            <div style="display: flex; gap: 15px; align-items: center;">
                <span>ðŸ‘¤ <strong id="username"></strong></span>
                <button class="btn-refresh" onclick="fetchLatestMetrics()">
                    <i class="fas fa-sync-alt"></i> Actualizar
                </button>
                <button class="btn-secondary" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Salir
                </button>
            </div>
        </div>

        <div id="message" class="message hidden"></div>

        <!-- InformaciÃ³n del dispositivo -->
        <div class="device-info">
            <h3><i class="fas fa-microchip"></i> InformaciÃ³n del Dispositivo</h3>
            <div class="info-row">
                <span><strong>ID:</strong></span>
                <span id="deviceId">--</span>
            </div>
            <div class="info-row">
                <span><strong>Nombre:</strong></span>
                <span id="deviceName">--</span>
            </div>
            <div class="info-row">
                <span><strong>IP:</strong></span>
                <span id="deviceIp">--</span>
            </div>
            <div class="info-row">
                <span><strong>MAC:</strong></span>
                <span id="deviceMac">--</span>
            </div>
        </div>

        <!-- Estado del motor -->
        <div class="metric-card">
            <h3>
                <span class="status-indicator status-offline" id="statusIndicator"></span>
                Estado: <span id="motorStatus">Desconectado</span>
            </h3>
            <p id="lastUpdate">Ãšltima actualizaciÃ³n: --</p>
        </div>

        <!-- MÃ©tricas en tiempo real -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-icon" style="color: #dc3545;">
                    <i class="fas fa-thermometer-half"></i>
                </div>
                <div class="metric-value" id="temperature">--</div>
                <div class="metric-label">Temperatura (Â°C)</div>
            </div>

            <div class="metric-card">
                <div class="metric-icon" style="color: #667eea;">
                    <i class="fas fa-tachometer-alt"></i>
                </div>
                <div class="metric-value" id="rpm">--</div>
                <div class="metric-label">RPM</div>
            </div>

            <div class="metric-card">
                <div class="metric-icon" style="color: #ffc107;">
                    <i class="fas fa-oil-can"></i>
                </div>
                <div class="metric-value" id="oilPressure">--</div>
                <div class="metric-label">PresiÃ³n Aceite (bar)</div>
            </div>

            <div class="metric-card">
                <div class="metric-icon" style="color: #28a745;">
                    <i class="fas fa-wave-square"></i>
                </div>
                <div class="metric-value" id="vibration">--</div>
                <div class="metric-label">VibraciÃ³n (mm/s)</div>
            </div>

            <div class="metric-card">
                <div class="metric-icon" style="color: #17a2b8;">
                    <i class="fas fa-weight-hanging"></i>
                </div>
                <div class="metric-value" id="loadPercentage">--</div>
                <div class="metric-label">Carga (%)</div>
            </div>
        </div>

        <!-- GrÃ¡fico histÃ³rico -->
        <div id="chartContainer">
            <h3><i class="fas fa-chart-line"></i> Historial de Temperatura y RPM</h3>
            <canvas id="chartCanvas"></canvas>
        </div>

        <!-- Eventos recientes -->
        <div class="events-container">
            <h3><i class="fas fa-exclamation-triangle"></i> Eventos Recientes</h3>
            <div id="eventsLog">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Esperando eventos...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // Variables globales
        let metricsChart;
        let temperatureData = [];
        let rpmData = [];
        let timeLabels = [];
        const MAX_DATA_POINTS = 50;
        let updateInterval;

        // InicializaciÃ³n
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('access_token');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            if (!token) {
                window.location.href = '/login';
                return;
            }

            document.getElementById('username').textContent = user.username || 'Usuario';
            
            // Inicializar grÃ¡fico
            initChart();
            
            // Cargar mÃ©tricas iniciales
            fetchLatestMetrics();
            
            // Actualizar cada 2 segundos
            updateInterval = setInterval(fetchLatestMetrics, 2000);
        });

        // Limpiar interval al salir
        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });

        // Inicializar Chart.js
        function initChart() {
            const ctx = document.getElementById('chartCanvas').getContext('2d');
            metricsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [
                        {
                            label: 'Temperatura (Â°C)',
                            data: temperatureData,
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y',
                        },
                        {
                            label: 'RPM',
                            data: rpmData,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y1',
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleColor: '#fff',
                            bodyColor: '#fff',
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Temperatura (Â°C)',
                                color: '#dc3545',
                                font: {
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                color: '#dc3545'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'RPM',
                                color: '#667eea',
                                font: {
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                color: '#667eea'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        },
                    }
                }
            });
        }

        // Obtener mÃ©tricas mÃ¡s recientes
        async function fetchLatestMetrics() {
            const token = localStorage.getItem('access_token');
            
            try {
                const response = await fetch('/metrics/latest', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 401) {
                    showMessage('SesiÃ³n expirada. Redirigiendo...', 'error');
                    setTimeout(() => {
                        localStorage.clear();
                        window.location.href = '/login';
                    }, 2000);
                    return;
                }

                if (!response.ok) {
                    throw new Error('Error obteniendo mÃ©tricas');
                }

                const data = await response.json();
                updateDashboard(data);
            } catch (error) {
                console.error('Error:', error);
                updateStatus('offline', 'Sin conexiÃ³n');
            }
        }

        // Actualizar dashboard con nuevas mÃ©tricas
        function updateDashboard(metrics) {
            // Actualizar informaciÃ³n del dispositivo
            document.getElementById('deviceId').textContent = metrics.device_id || '--';
            document.getElementById('deviceName').textContent = metrics.device_name || '--';
            document.getElementById('deviceIp').textContent = metrics.device_ip || '--';
            document.getElementById('deviceMac').textContent = metrics.device_mac || '--';

            // Actualizar valores de mÃ©tricas
            document.getElementById('temperature').textContent = metrics.temperature.toFixed(1);
            document.getElementById('rpm').textContent = Math.round(metrics.rpm);
            document.getElementById('oilPressure').textContent = metrics.oil_pressure.toFixed(2);
            document.getElementById('vibration').textContent = metrics.vibration.toFixed(3);
            document.getElementById('loadPercentage').textContent = metrics.load_percentage.toFixed(1);

            // Actualizar estado
            updateStatus(metrics.status, metrics.status);
            
            // Ãšltima actualizaciÃ³n
            document.getElementById('lastUpdate').textContent = 
                `Ãšltima actualizaciÃ³n: ${metrics.datetime}`;

            // Agregar al grÃ¡fico
            const now = new Date().toLocaleTimeString();
            timeLabels.push(now);
            temperatureData.push(metrics.temperature);
            rpmData.push(metrics.rpm);

            // Mantener solo Ãºltimos N puntos
            if (timeLabels.length > MAX_DATA_POINTS) {
                timeLabels.shift();
                temperatureData.shift();
                rpmData.shift();
            }

            metricsChart.update('none'); // Actualizar sin animaciÃ³n para mejor performance

            // Mostrar evento si existe
            if (metrics.event) {
                addEvent(metrics.event, metrics.datetime, metrics.status === 'error');
            }
        }

        // Actualizar indicador de estado
        function updateStatus(status, text) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('motorStatus');
            
            // Remover todas las clases de estado
            indicator.className = 'status-indicator';
            
            switch(status) {
                case 'running':
                    indicator.classList.add('status-running');
                    statusText.textContent = 'âœ“ Operando Normalmente';
                    statusText.style.color = '#28a745';
                    break;
                case 'warning':
                    indicator.classList.add('status-warning');
                    statusText.textContent = 'âš  Advertencia';
                    statusText.style.color = '#ffc107';
                    break;
                case 'error':
                    indicator.classList.add('status-error');
                    statusText.textContent = 'âœ— Error CrÃ­tico';
                    statusText.style.color = '#dc3545';
                    break;
                default:
                    indicator.classList.add('status-offline');
                    statusText.textContent = 'â—‹ ' + (text || 'Desconectado');
                    statusText.style.color = '#6c757d';
            }
        }

        // Agregar evento al log
        function addEvent(event, datetime, isCritical = false) {
            const eventsLog = document.getElementById('eventsLog');
            
            // Limpiar mensaje de carga si existe
            const loadingDiv = eventsLog.querySelector('.loading');
            if (loadingDiv) {
                eventsLog.innerHTML = '';
            }

            const eventDiv = document.createElement('div');
            eventDiv.className = isCritical ? 'event-item event-critical' : 'event-item';
            
            const icon = isCritical ? 
                '<i class="fas fa-exclamation-circle" style="color: #dc3545;"></i>' : 
                '<i class="fas fa-exclamation-triangle" style="color: #ffc107;"></i>';
            
            eventDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        ${icon} <strong>${formatEventName(event)}</strong>
                    </div>
                    <small style="color: #666;">${datetime}</small>
                </div>
            `;
            
            eventsLog.insertBefore(eventDiv, eventsLog.firstChild);
            
            // Mantener solo Ãºltimos 10 eventos
            while (eventsLog.children.length > 10) {
                eventsLog.removeChild(eventsLog.lastChild);
            }
        }

        // Formatear nombre del evento
        function formatEventName(event) {
            const eventNames = {
                'high_temperature_warning': 'Alta Temperatura Detectada',
                'rpm_spike': 'Pico Anormal de RPM',
                'low_oil_pressure': 'PresiÃ³n de Aceite Baja',
                'high_vibration': 'VibraciÃ³n Excesiva'
            };
            return eventNames[event] || event;
        }

        // Logout
        function logout() {
            if (confirm('Â¿Seguro que deseas cerrar sesiÃ³n?')) {
                if (updateInterval) {
                    clearInterval(updateInterval);
                }
                localStorage.clear();
                window.location.href = '/login';
            }
        }

        // Mostrar mensajes
        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
            messageDiv.classList.remove('hidden');
            
            setTimeout(() => {
                messageDiv.classList.add('hidden');
            }, 5000);
        }
    </script>
</body>
</html>
